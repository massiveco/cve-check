package collectors

import (
	"os/exec"
	"strings"

	"github.com/massiveco/cve-check/inventory"
)

const collectorName = "apk"

// Apk collector for the Alpine Package Keeper
type Apk struct {
	command *exec.Cmd
}

// New create a new Apk object
func New() Apk {
	return Apk{
		command: exec.Command("apk", "info", "-v"),
	}
}

// Packages returns a list of the packages managed by APK
func (a Apk) Packages() (*inventory.Inventory, error) {
	inv := inventory.Inventory{}

	response, err := a.command.Output()
	if err != nil {
		return nil, err
	}

	lines := strings.Split(string(response[:]), "\n")

	for _, pkgName := range lines {
		pkg, err := inventory.NewItem(pkgName, collectorName)
		if err != nil {
			continue
		}
		inv.Items = append(inv.Items, *pkg)

	}

	return &inv, nil
}
